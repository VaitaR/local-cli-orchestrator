<div id="run-header"
     {% if run.is_active %}
     hx-get="/partials/run-header/{{ run.run_id }}"
     hx-trigger="every {{ poll_interval }}s"
     hx-swap="outerHTML"
     {% endif %}
     class="run-header">
    
    <div class="run-title">
        <h1>ğŸ”– {{ run.run_id }}</h1>
        <span class="badge badge-{{ run.status.value }} badge-lg">
            {% if run.status.value == 'running' %}âš¡ {% endif %}
            {% if run.status.value == 'completed' %}âœ“ {% endif %}
            {% if run.status.value == 'failed' %}âœ• {% endif %}
            {{ run.status.value }}
        </span>
    </div>
    
    <div class="run-meta">
        <div class="meta-item">
            <span class="label">ğŸ“ Stage</span>
            <span class="value">{{ run.current_stage or 'N/A' }}</span>
        </div>
        {% if run.started_at %}
        <div class="meta-item">
            <span class="label">ğŸ• Started</span>
            <span class="value mono">
                <span data-local-time data-iso="{{ run.created_at_iso or '' }}">-</span>
            </span>
        </div>
        {% endif %}
        <div class="meta-item">
            <span class="label">â± Elapsed</span>
            <span class="value mono">
                <span data-timer-for="{{ run.run_id }}"
                      data-started-at="{{ run.started_at }}"
                      data-run-status="{{ run.status.value }}">
                    {{ run.elapsed_human }}
                </span>
            </span>
        </div>
        {% if run.repo_path %}
        <div class="meta-item">
            <span class="label">ğŸ“ Repo</span>
            <span class="value mono">{{ run.repo_path }}</span>
        </div>
        {% endif %}
        {% if run.base_branch %}
        <div class="meta-item">
            <span class="label">ğŸŒ¿ Branch</span>
            <span class="value mono">{{ run.base_branch }}</span>
        </div>
        {% endif %}
        {% if run.base_sha %}
        <div class="meta-item">
            <span class="label">ğŸ”— SHA</span>
            <span class="value mono">{{ run.base_sha[:8] }}</span>
        </div>
        {% endif %}
    </div>
    
    {% if run.last_error and not run.is_active %}
    <div class="error-banner">
        <strong>âš ï¸ Error:</strong> 
        {% if run.last_error.category %}{{ run.last_error.category }}: {% endif %}
        {{ run.last_error.message or 'Unknown error' }}
    </div>
    {% endif %}
    
    <div class="run-actions">
        {% if run.can_cancel %}
        <button class="btn btn-danger"
                hx-post="/api/runs/{{ run.run_id }}/cancel"
                hx-confirm="Cancel this run?"
                hx-swap="none"
                hx-on::after-request="setTimeout(() => htmx.trigger('#run-header', 'htmx:load'), 500)">
            ğŸ›‘ Cancel Run
        </button>
        {% elif not run.is_active %}
        <button class="btn btn-primary"
                hx-post="/api/runs/{{ run.run_id }}/restart"
                hx-confirm="Restart this run with the same configuration?"
                hx-swap="none"
                hx-on::after-request="handleRestartResponse(event)">
            ğŸ”„ Restart Run
        </button>
        {% endif %}
    </div>
</div>

<script>
function handleRestartResponse(event) {
    try {
        const xhr = event.detail.xhr;
        if (xhr.status === 200) {
            const response = JSON.parse(xhr.response);
            if (response.new_run_id) {
                // Redirect to the new run
                window.location.href = `/runs/${response.new_run_id}`;
            }
        }
    } catch (e) {
        console.error('Error handling restart response:', e);
        setTimeout(() => htmx.trigger('#run-header', 'htmx:load'), 500);
    }
}
</script>
