<div class="tab-content">
    {% if artifacts %}
    {# Map file extensions to icons #}
    {% set file_icons = {
        'md': 'ğŸ“', 'markdown': 'ğŸ“',
        'yaml': 'âš™ï¸', 'yml': 'âš™ï¸',
        'json': 'ğŸ“‹', 'jsonl': 'ğŸ“‹',
        'py': 'ğŸ', 'python': 'ğŸ',
        'js': 'ğŸŸ¨', 'ts': 'ğŸ”·', 'tsx': 'ğŸ”·', 'jsx': 'ğŸŸ¨',
        'log': 'ğŸ“œ', 'txt': 'ğŸ“„',
        'diff': 'ğŸ”€', 'patch': 'ğŸ”€',
        'sh': 'ğŸ’»', 'bash': 'ğŸ’»', 'zsh': 'ğŸ’»',
        'html': 'ğŸŒ', 'css': 'ğŸ¨',
        'toml': 'âš™ï¸', 'ini': 'âš™ï¸', 'cfg': 'âš™ï¸'
    } %}
    <div class="artifacts-layout">
        {# File Explorer Sidebar #}
        <div class="artifacts-sidebar">
            <div class="artifacts-header">
                <h3>Explorer</h3>
                <span class="badge badge-info">{{ artifacts | length }}</span>
            </div>
            <div class="artifacts-search">
                <input
                    type="text"
                    id="artifact-search"
                    class="search-input"
                    placeholder="âŒ˜K Search files..."
                    autocomplete="off"
                >
            </div>
            <div class="artifacts-list" id="artifacts-list">
                {% for artifact in artifacts %}
                {% set ext = artifact.name.split('.')[-1] | lower %}
                {% set icon = file_icons.get(ext, 'ğŸ“„') %}
                <div class="artifact-item {% if loop.first %}active{% endif %}"
                     hx-get="/partials/artifact/{{ run_id }}?path={{ artifact.path | urlencode }}"
                     hx-target="#artifact-preview-content"
                     hx-swap="innerHTML"
                     hx-indicator=".artifact-loading"
                     data-filename="{{ artifact.name }}"
                     data-path="{{ artifact.path }}"
                     onclick="selectArtifact(this)">
                    <div class="artifact-info">
                        <span class="artifact-icon">{{ icon }}</span>
                        <div class="artifact-details">
                            <span class="artifact-name" data-path="{{ artifact.path }}">{{ artifact.name }}</span>
                            <span class="artifact-meta">{{ (artifact.size_bytes / 1024) | round(1) }} KB</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        {# Code Preview Panel #}
        <div class="artifacts-preview">
            <div class="preview-header">
                <div class="preview-title" id="preview-title">
                    {% set first_ext = artifacts[0].name.split('.')[-1] | lower if artifacts else '' %}
                    {% set first_icon = file_icons.get(first_ext, 'ğŸ“„') %}
                    <span class="preview-icon" id="preview-icon">{{ first_icon }}</span>
                    <span class="preview-filename" id="preview-filename">{{ artifacts[0].name if artifacts else 'Select a file' }}</span>
                    {% if artifacts and '/' in artifacts[0].path %}
                    <span class="preview-path" id="preview-path">{{ artifacts[0].path | replace(artifacts[0].name, '') }}</span>
                    {% endif %}
                </div>
                <div class="preview-actions">
                    <button class="btn btn-sm btn-secondary" onclick="copyArtifactContent()" title="Copy to clipboard (âŒ˜C)">
                        ğŸ“‹
                    </button>
                </div>
            </div>
            <div class="artifact-loading"></div>
            <div id="artifact-preview-content" class="preview-content">
                {% if artifacts[0].path %}
                <iframe
                    hx-get="/partials/artifact/{{ run_id }}?path={{ artifacts[0].path | urlencode }}"
                    hx-swap="none"
                    hx-trigger="load"
                    style="display:none;">
                </iframe>
                {% else %}
                <div class="empty-state">
                    <p>Select a file to preview</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    {% else %}
    <div class="empty-state">
        <p>ğŸ“ No artifacts available</p>
        <small>Artifacts will appear as the run progresses</small>
    </div>
    {% endif %}
</div>

<script>
// File icons map for dynamic updates
const FILE_ICONS = {
    'md': 'ğŸ“', 'markdown': 'ğŸ“',
    'yaml': 'âš™ï¸', 'yml': 'âš™ï¸',
    'json': 'ğŸ“‹', 'jsonl': 'ğŸ“‹',
    'py': 'ğŸ', 'python': 'ğŸ',
    'js': 'ğŸŸ¨', 'ts': 'ğŸ”·', 'tsx': 'ğŸ”·', 'jsx': 'ğŸŸ¨',
    'log': 'ğŸ“œ', 'txt': 'ğŸ“„',
    'diff': 'ğŸ”€', 'patch': 'ğŸ”€',
    'sh': 'ğŸ’»', 'bash': 'ğŸ’»', 'zsh': 'ğŸ’»',
    'html': 'ğŸŒ', 'css': 'ğŸ¨',
    'toml': 'âš™ï¸', 'ini': 'âš™ï¸', 'cfg': 'âš™ï¸'
};

function getFileIcon(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    return FILE_ICONS[ext] || 'ğŸ“„';
}

function selectArtifact(element) {
    // Remove active from all items
    document.querySelectorAll('.artifact-item').forEach(item => {
        item.classList.remove('active');
    });
    // Add active to clicked item
    element.classList.add('active');
    
    // Update preview header
    const filename = element.dataset.filename;
    const path = element.dataset.path;
    
    const previewIcon = document.getElementById('preview-icon');
    const previewFilename = document.getElementById('preview-filename');
    const previewPath = document.getElementById('preview-path');
    
    if (previewIcon) previewIcon.textContent = getFileIcon(filename);
    if (previewFilename) previewFilename.textContent = filename;
    if (previewPath) {
        const dirPath = path.replace(filename, '');
        previewPath.textContent = dirPath || '';
    }
}

function copyArtifactContent() {
    const codeElement = document.querySelector('#artifact-preview-content code');
    if (!codeElement) return;

    const text = codeElement.innerText || codeElement.textContent;

    // Try modern Clipboard API first
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
            showCopyFeedback();
        }).catch(() => {
            fallbackCopy(text);
        });
    } else {
        fallbackCopy(text);
    }
}

function fallbackCopy(text) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.top = '-9999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        document.execCommand('copy');
        showCopyFeedback();
    } catch (err) {
        console.error('Failed to copy:', err);
    }

    document.body.removeChild(textArea);
}

function showCopyFeedback() {
    const btn = document.querySelector('.preview-actions .btn');
    if (!btn) return;

    const originalHTML = btn.innerHTML;
    btn.innerHTML = 'âœ“';
    btn.style.background = 'var(--success)';
    btn.style.color = 'white';

    setTimeout(() => {
        btn.innerHTML = originalHTML;
        btn.style.background = '';
        btn.style.color = '';
    }, 1500);
}

// Debounced search functionality for artifacts
(function() {
    function initArtifactSearch(root) {
        const scope = root || document;

        const searchInput = (scope === document) ? document.getElementById('artifact-search') : scope.querySelector('#artifact-search');
        const artifactsList = (scope === document) ? document.getElementById('artifacts-list') : scope.querySelector('#artifacts-list');
        if (!searchInput || !artifactsList) return;

        // Avoid double-initialization
        if (searchInput.dataset.artifactSearchInit === '1') return;
        searchInput.dataset.artifactSearchInit = '1';

        let searchTimeout;

        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);

            searchTimeout = setTimeout(function() {
                const searchTerm = searchInput.value.toLowerCase().trim();
                const artifactItems = artifactsList.querySelectorAll('.artifact-item');
                let visibleCount = 0;

                artifactItems.forEach(function(item) {
                    const filename = (item.dataset.filename || '').toLowerCase();
                    const path = (item.dataset.path || '').toLowerCase();

                    const matchesSearch = filename.includes(searchTerm) || path.includes(searchTerm);

                    if (matchesSearch || searchTerm === '') {
                        item.style.display = '';
                        visibleCount++;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Show "no results" message if needed
                let noResultsMsg = artifactsList.querySelector('.no-artifacts-message');
                if (visibleCount === 0 && searchTerm !== '') {
                    if (!noResultsMsg) {
                        noResultsMsg = document.createElement('div');
                        noResultsMsg.className = 'no-artifacts-message';
                        noResultsMsg.innerHTML = '<p>No files match "' + searchTerm + '"</p>';
                        artifactsList.appendChild(noResultsMsg);
                    }
                } else if (noResultsMsg) {
                    noResultsMsg.remove();
                }
            }, 100);
        });

        // Keyboard shortcuts
        searchInput.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                searchInput.value = '';
                searchInput.dispatchEvent(new Event('input'));
                searchInput.blur();
            }
            // Arrow navigation
            if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                e.preventDefault();
                const items = Array.from(artifactsList.querySelectorAll('.artifact-item:not([style*="display: none"])'));
                const currentActive = artifactsList.querySelector('.artifact-item.active');
                const currentIndex = items.indexOf(currentActive);
                
                let nextIndex;
                if (e.key === 'ArrowDown') {
                    nextIndex = currentIndex < items.length - 1 ? currentIndex + 1 : 0;
                } else {
                    nextIndex = currentIndex > 0 ? currentIndex - 1 : items.length - 1;
                }
                
                if (items[nextIndex]) {
                    items[nextIndex].click();
                    items[nextIndex].scrollIntoView({ block: 'nearest' });
                }
            }
            // Enter to focus preview
            if (e.key === 'Enter') {
                const previewContent = document.getElementById('artifact-preview-content');
                if (previewContent) previewContent.focus();
            }
        });
    }

    // Run on initial load if present
    initArtifactSearch(document);

    // Also initialize when HTMX swaps the tab content in
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        try {
            const target = evt && evt.detail && evt.detail.target;
            if (!target) return;

            if (target.id === 'artifacts-list' || target.id === 'artifact-preview-content' || (typeof target.querySelector === 'function' && target.querySelector('#artifact-search'))) {
                initArtifactSearch(target);
            }
        } catch (e) {
            console.error('Artifact search init failed after HTMX swap:', e);
        }
    });
    
    // Global keyboard shortcut âŒ˜K / Ctrl+K to focus search
    document.addEventListener('keydown', function(e) {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            const searchInput = document.getElementById('artifact-search');
            if (searchInput) {
                e.preventDefault();
                searchInput.focus();
                searchInput.select();
            }
        }
    });
})();
</script>
