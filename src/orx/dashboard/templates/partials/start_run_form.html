<div class="modal-header">
    <h3>Start New Run</h3>
    <button class="btn-close" onclick="document.getElementById('modal').classList.remove('active')">&times;</button>
</div>
<form id="start-run-form"
      class="form">
    <div class="form-group">
        <label for="task">Task Description *</label>
        <textarea id="task" 
                  rows="6" 
                  required
                  placeholder="Describe what you want to accomplish..."></textarea>
        <small>Or use @filepath to read from file</small>
    </div>
    
    <div class="form-group">
        <label for="repo_path">Repository Path</label>
        <input type="text" 
               id="repo_path" 
               value="{{ default_repo_path }}"
               placeholder="Current directory if empty">
    </div>
    
    <div class="form-group">
        <label for="base_branch">Base Branch</label>
        <input type="text" 
               id="base_branch" 
               placeholder="main">
    </div>
    
    <div class="form-actions">
        <button type="button" 
                class="btn btn-secondary"
                onclick="document.getElementById('modal').classList.remove('active')">
            Cancel
        </button>
        <button type="submit" class="btn btn-primary">
            Start Run
        </button>
    </div>
</form>

<script>
document.getElementById('start-run-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const task = document.getElementById('task').value;
    const repo_path = document.getElementById('repo_path').value || null;
    const base_branch = document.getElementById('base_branch').value || null;
    
    console.log('Submitting form with:', { task, repo_path, base_branch });
    
    try {
        const response = await fetch('/api/runs/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                task: task,
                repo_path: repo_path,
                base_branch: base_branch,
                config_overrides: {}
            })
        });
        
        if (!response.ok) {
            let error_detail = 'Failed to start run';
            try {
                const error = await response.json();
                error_detail = error.detail || JSON.stringify(error);
            } catch (e) {
                // Response is not JSON
                const text = await response.text();
                error_detail = `HTTP ${response.status}: ${text.substring(0, 200)}`;
            }
            console.error('API Error:', error_detail);
            alert(`Error: ${error_detail}`);
            return;
        }
        
        const result = await response.json();
        console.log('Run started:', result);
        alert(`Run started: ${result.run_id}`);
        document.getElementById('modal').classList.remove('active');
        
        // Refresh the runs list
        htmx.ajax('GET', '/partials/active-runs', {target: '#active-runs', swap: 'innerHTML'});
        htmx.ajax('GET', '/partials/recent-runs', {target: '#recent-runs', swap: 'innerHTML'});
        
    } catch (error) {
        console.error('Request error:', error);
        alert(`Error: ${error.message}`);
    }
});
</script>
